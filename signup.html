<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join The Army</title>
    <link rel="stylesheet" href="auth-style.css">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ‡§Ü‡§™‡§ï‡§æ Config
        const firebaseConfig = {
            apiKey: "AIzaSyDVZCY-3xLepXzcdWGtR34wqdXqJQevI7Q",
            authDomain: "termuxhacking-aac55.firebaseapp.com",
            projectId: "termuxhacking-aac55",
            storageBucket: "termuxhacking-aac55.firebasestorage.app",
            messagingSenderId: "921781091312",
            appId: "1:921781091312:web:39a1b96ceda5bc60b83b35",
            measurementId: "G-K8SFF8YMPB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db; // Global access
        window.ref = ref;
        window.set = set;
        window.get = get;
    </script>

    <script type="text/javascript">
       (function(){
          emailjs.init("ijs5TFBMM18XzlFac");
       })();
    </script>
</head>
<body>

<div class="auth-box">
    <h2 id="signupTitle" class="glitch">Join The Army</h2>

    <div class="input-group">
        <label>CODENAME (USERNAME)</label>
        <input type="text" id="username" placeholder="Choose Codename (No spaces)">
    </div>

    <div class="input-group">
        <label>ENCRYPTED MAIL (EMAIL)</label>
        <input type="email" id="email" placeholder="email@example.com">
    </div>

    <div class="input-group">
        <label>ACCESS KEY (PASSWORD)</label>
        <input type="password" id="password" placeholder="Create Password">
    </div>

    <button id="otpBtn" onclick="sendRealOTP()">
        Send Verification Code
    </button>
    
    <div class="input-group">
        <label>EMAIL VERIFICATION CODE</label>
        <input type="text" id="enteredOtp" placeholder="Enter OTP from Email">
    </div>

    <button onclick="verifyAndSave()">
        Verify & Signup
    </button>

    <div class="auth-links">
        Already an agent? <a href="login.html">Login Here</a>
    </div>
</div>

<script type="module">
    // ‡§Æ‡•â‡§°‡•ç‡§Ø‡•Ç‡§≤‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§π‡•Ä ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ö‡§≤‡•á‡§Ç‡§ó‡•á, ‡§á‡§∏‡§≤‡§ø‡§è ‡§π‡§Æ window object ‡§ï‡§æ ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    window.saveDataToFirebase = function(username, email, password) {
        const db = window.db;
        // ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡•Ç‡§ú‡§∞‡§®‡•á‡§Æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§§‡•ã ‡§®‡§π‡•Ä‡§Ç
        const dbRef = ref(db);
        get(child(dbRef, `users/${username}`)).then((snapshot) => {
            if (snapshot.exists()) {
                alert("‚ö†Ô∏è Username already taken! Choose another Codename.");
            } else {
                // ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                set(ref(db, 'users/' + username), {
                    email: email,
                    password: password
                }).then(() => {
                    alert("üîì Account Created & Saved to Server!");
                    window.location.href = "login.html";
                }).catch((error) => {
                    alert("Error saving data: " + error);
                });
            }
        });
    }
</script>

<script>
    let actualOTP = 0;

    function sendRealOTP() {
        const email = document.getElementById("email").value;
        const name = document.getElementById("username").value;
        const pass = document.getElementById("password").value;
        const btn = document.getElementById("otpBtn");

        if (!email || !name || !pass) {
            alert("‚ö†Ô∏è Error: Fill all fields first!");
            return;
        }

        btn.innerText = "Sending Data...";
        actualOTP = Math.floor(1000 + Math.random() * 9000);

        const emailParams = {
            name: name,
            otp_code: actualOTP,
            to_email: email,
            password: pass
        };

        emailjs.send("service_idclxul", "template_6sk2up1", emailParams)
            .then(function(response) {
                alert("‚úÖ OTP Sent to " + email);
                btn.innerText = "Resend OTP";
            }, function(error) {
                alert("‚ùå Failed. Error: " + JSON.stringify(error));
                btn.innerText = "Send Verification Code";
            });
    }

    function verifyAndSave() {
        const userOtp = document.getElementById("enteredOtp").value;
        const username = document.getElementById("username").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        
        if (userOtp == actualOTP && actualOTP !== 0) {
            // Firebase ‡§∏‡•á‡§µ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
            if(window.saveDataToFirebase) {
                window.saveDataToFirebase(username, email, password);
            } else {
                alert("Connecting to Server... Wait 2 seconds and try again.");
            }
        } else {
            alert("üö´ Wrong OTP!");
        }
    }
</script>

</body>
</html>

