<?php
session_start();
include 'db_connect.php';

$isLoggedIn = isset($_SESSION['user_id']);
$username = $isLoggedIn ? $_SESSION['username'] : "Guest";
$role = isset($_SESSION['role']) ? $_SESSION['role'] : "guest";
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<?php
session_start();
include 'db_connect.php';

// User State Check
$isLoggedIn = isset($_SESSION['user_id']) || (isset($_SESSION['role']) && $_SESSION['role'] === 'admin');
$username = $isLoggedIn ? $_SESSION['username'] : "Guest";
$role = isset($_SESSION['role']) ? $_SESSION['role'] : "guest";
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Termux Hacking Family</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
    /* Live Banner */
    #live-banner { display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743); color: white; padding: 10px; z-index: 9999; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    
    /* Modal (Video Popup) */
    .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.95); }
    .modal-content { background-color: #0d1117; margin: 5% auto; padding: 20px; border: 1px solid #00ff41; width: 90%; max-width: 700px; color: #fff; border-radius: 8px; position: relative; }
    .close { color: #ff0055; position: absolute; top: 10px; right: 20px; font-size: 30px; font-weight: bold; cursor: pointer; }
    
    /* Admin Panel Style */
    .admin-panel { border: 2px dashed #ff0055; padding: 15px; margin: 20px 0; background: #1a0505; display: <?php echo ($role === 'admin') ? 'block' : 'none'; ?>; }
    .input-dark { width: 100%; padding: 10px; margin: 5px 0; background: #000; color: #0f0; border: 1px solid #333; }
</style>
</head>

<body>

<div id="live-banner">
    <div style="display:flex; align-items:center; gap:10px;">
        <div style="width:10px; height:10px; background:white; border-radius:50%; animation:blink 1s infinite;"></div>
        <strong>ADMIN LIVE:</strong> <span id="live-msg-text">Join the War Room!</span>
    </div>
    <button onclick="document.getElementById('live-banner').style.display='none'" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
</div>

<header>
  <div class="logo">Termux Family <?php if($role=='admin') echo "<span style='color:red; font-size:12px;'>(ADMIN)</span>"; ?></div>
  <div class="menu-icon" onclick="openNav()">‚ò∞</div>
</header>

<div id="mySidebar" class="sidebar">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <div style="padding: 10px 25px; color: #00ff41; border-bottom:1px solid #333; margin-bottom:10px;">
      STATUS: <span style="color:<?php echo $isLoggedIn?'#00ff41':'#666'; ?>"><?php echo $isLoggedIn?'ONLINE':'GUEST'; ?></span><br>
      AGENT: <?php echo htmlspecialchars($username); ?>
  </div>
  <a href="index.php">üè† Home</a>
  <?php if ($role === 'prime' || $role === 'admin'): ?>
      <a href="#" style="color:gold;">üëë Prime Zone</a>
  <?php endif; ?>
  
  <?php if ($isLoggedIn): ?>
      <a href="logout.php" style="color:#ff0055;">üö´ Logout</a>
  <?php else: ?>
      <a href="login.php" style="color:gold;">üîë Login</a>
      <a href="signup.php">üìù Signup</a>
  <?php endif; ?>
</div>

<div class="container">

    <div class="admin-panel">
        <h3 style="color:red; margin-bottom:10px;">‚ö†Ô∏è ADMIN CONTROL ROOM</h3>
        
        <div style="margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:15px;">
            <label style="color:white;">üî¥ Broadcast Message:</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="live-msg-input" class="input-dark" placeholder="Enter message for users...">
                <button onclick="triggerLive()" style="background:red; color:white; border:none; padding:0 20px; cursor:pointer; font-weight:bold;">GO LIVE</button>
            </div>
            <span id="live-count" style="color:#666; font-size:12px;">Usage: 0/3 Today</span>
        </div>

        <form action="save_command.php" method="POST">
            <h4 style="color:#00ff41;">üõ† Upload New Tool</h4>
            <input type="text" name="tool_name" class="input-dark" placeholder="Tool Name" required>
            <textarea name="tool_commands" class="input-dark" style="height:80px;" placeholder="Commands / Installation Steps..." required></textarea>
            <input type="text" name="tool_img" class="input-dark" placeholder="Image URL (e.g., https://site.com/img.jpg)">
            <input type="text" name="tool_video" class="input-dark" placeholder="YouTube Video ID (e.g. dQw4w9WgXcQ)">
            <button type="submit" style="background:#00ff41; color:black; width:100%; padding:10px; border:none; font-weight:bold; cursor:pointer; margin-top:5px;">UPLOAD TO DATABASE</button>
        </form>
    </div>

    <div id="tools-container">
        <h2 style="color:#00ff41; text-align:center; margin-bottom:20px;">LATEST ARSENAL</h2>
        
        <?php
        $query = "SELECT * FROM termux_tools ORDER BY id DESC";
        $res = mysqli_query($conn, $query);
        
        if(mysqli_num_rows($res) > 0) {
            echo '<div class="grid-container" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">';
            
            while($row = mysqli_fetch_assoc($res)) {
                // Prepare Data for JS
                $t_name = htmlspecialchars($row['tool_name']);
                $t_cmd = htmlspecialchars($row['tool_commands']); 
                $t_img = !empty($row['tool_img']) ? $row['tool_img'] : 'https://via.placeholder.com/300x150/000000/00ff41?text=Termux+Tool';
                $t_vid = !empty($row['tool_video']) ? $row['tool_video'] : '';
        ?>
            <div class="card" style="border: 1px solid #333; background:#0d1117; padding:0; overflow:hidden;">
                <img src="<?php echo $t_img; ?>" style="width:100%; height:160px; object-fit:cover; border-bottom:1px solid #333;">
                <div style="padding:15px;">
                    <h3 style="color: #00ff41; margin-bottom:10px;"><?php echo $t_name; ?></h3>
                    <p style="color:#888; font-size:12px; margin-bottom:15px;">Click below to view commands & video tutorial.</p>
                    
                    <button onclick='openArticle(<?php echo json_encode($t_name); ?>, <?php echo json_encode($t_cmd); ?>, <?php echo json_encode($t_img); ?>, <?php echo json_encode($t_vid); ?>)' 
                    style="background: #21262d; color: #00ff41; border: 1px solid #00ff41; width: 100%; padding: 10px; cursor: pointer; font-family:monospace;">
                        [ SEE ALL / READ MORE ]
                    </button>
                </div>
            </div>
        <?php 
            } 
            echo '</div>'; // End Grid
        } else {
            echo "<p style='text-align:center; color:#666;'>No tools uploaded yet.</p>";
        }
        ?>
    </div>

</div>

<div id="articleModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeArticle()">&times;</span>
    
    <h2 id="modal-title" style="color:#00ff41; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">Tool Name</h2>
    
    <div style="display:flex; flex-direction:column; gap:15px;">
        <img id="modal-img" src="" style="width:100%; max-height:250px; object-fit:cover; border-radius:5px;">
        
        <div>
            <h3 style="color:gold; font-size:14px; margin-bottom:5px;">TERMINAL COMMANDS:</h3>
            <div id="modal-desc" style="background:#000; padding:15px; border:1px dashed #333; white-space: pre-wrap; font-family:monospace; color:#ccc; max-height:200px; overflow-y:auto;"></div>
        </div>

        <div id="video-container" style="display:none;">
            <h3 style="color:#ff0055; font-size:14px; margin-bottom:5px;">VIDEO TUTORIAL:</h3>
            <iframe id="modal-video" width="100%" height="300" src="" frameborder="0" allowfullscreen style="border:1px solid #333;"></iframe>
        </div>
    </div>
  </div>
</div>

<script src="main.js"></script>
</body>
</html>

