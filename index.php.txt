<?php
session_start();
include 'db_connect.php';

$isLoggedIn = isset($_SESSION['user_id']);
$username = $isLoggedIn ? $_SESSION['username'] : "Guest";
$role = isset($_SESSION['role']) ? $_SESSION['role'] : "guest";
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Termux Hacking Family</title>
<link rel="stylesheet" href="style.css">
<style>
    /* Live Banner */
    #live-banner { display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743); color: white; padding: 10px; z-index: 9999; justify-content: space-between; align-items: center; }
    
    /* Modal Viewer */
    .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); }
    .modal-content { background-color: #111; margin: 5% auto; padding: 20px; border: 1px solid #00ff41; width: 90%; max-width: 600px; color: #fff; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    
    /* Admin Panel */
    .admin-panel { border: 2px dashed red; padding: 15px; margin: 20px 0; background: #1a0000; display: <?php echo ($role === 'admin') ? 'block' : 'none'; ?>; }
</style>
</head>

<body>

<div id="live-banner">
    <div>üî¥ <strong>ADMIN LIVE:</strong> <span id="live-msg-text">Join the War Room!</span></div>
    <button onclick="document.getElementById('live-banner').style.display='none'" style="background:none; border:none; color:white; font-size:20px;">&times;</button>
</div>

<header>
  <div class="logo">Termux Family <?php if($role=='admin') echo "<span style='color:red; font-size:10px;'>(ADMIN MODE)</span>"; ?></div>
  <div class="menu-icon" onclick="openNav()">‚ò∞</div>
</header>

<div id="mySidebar" class="sidebar">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <div style="padding: 10px 25px; color: #00ff41;">USER: <?php echo htmlspecialchars($username); ?></div>
  <a href="index.php">üè† Home</a>
  <?php if ($role === 'prime' || $role === 'admin'): ?>
      <a href="#" style="color:gold;">üëë Prime Content</a>
  <?php endif; ?>
  <?php if ($isLoggedIn): ?>
      <a href="logout.php" style="color:red;">üö´ Logout</a>
  <?php else: ?>
      <a href="login.php">üîë Login</a>
  <?php endif; ?>
</div>

<div class="container">

    <div class="admin-panel">
        <h3 style="color:red;">‚ö†Ô∏è ADMIN CONTROL</h3>
        
        <div style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
            <input type="text" id="live-msg-input" placeholder="Live Message" style="padding:5px; width:60%;">
            <button onclick="triggerLive()" style="background:red; color:white; padding:5px 10px;">GO LIVE (Limit: 3)</button>
            <span id="live-count" style="color:#666; font-size:12px; margin-left:10px;">0/3 Used</span>
        </div>

        <form action="save_command.php" method="POST">
            <h4 style="color:#00ff41;">Upload Tool</h4>
            <input type="text" name="tool_name" placeholder="Tool Name" required style="width:100%; margin-bottom:5px;">
            <textarea name="tool_commands" placeholder="Step by Step Commands" required style="width:100%; height:80px; margin-bottom:5px;"></textarea>
            <input type="text" name="tool_img" placeholder="Image URL (http...)" style="width:100%; margin-bottom:5px;">
            <input type="text" name="tool_video" placeholder="YouTube Video ID (e.g. dQw4w9WgXcQ)" style="width:100%; margin-bottom:5px;">
            <button type="submit" style="background:#00ff41; width:100%;">UPLOAD TO DB</button>
        </form>
    </div>

    <div id="tools-container">
        <h2 style="color:#00ff41; text-align:center;">LATEST TOOLS</h2>
        <?php
        $query = "SELECT * FROM termux_tools ORDER BY id DESC";
        $res = mysqli_query($conn, $query);
        while($row = mysqli_fetch_assoc($res)) {
            // Data Setup for Modal
            $t_name = htmlspecialchars($row['tool_name']);
            $t_cmd = htmlspecialchars($row['tool_commands']); 
            $t_img = !empty($row['tool_img']) ? $row['tool_img'] : 'https://via.placeholder.com/300';
            $t_vid = !empty($row['tool_video']) ? $row['tool_video'] : '';
        ?>
        <div class="card" style="border: 1px solid #333; margin-bottom: 20px; padding: 15px;">
            <img src="<?php echo $t_img; ?>" style="width:100%; height:150px; object-fit:cover; border-radius:5px;">
            <h3 style="color: #00ff00; margin:10px 0;"><?php echo $t_name; ?></h3>
            
            <button onclick='openArticle(<?php echo json_encode($t_name); ?>, <?php echo json_encode($t_cmd); ?>, <?php echo json_encode($t_img); ?>, <?php echo json_encode($t_vid); ?>)' 
            style="background: #00ff41; color: black; width: 100%; padding: 10px; border: none; font-weight: bold; cursor: pointer;">
                SEE ALL / READ MORE
            </button>
        </div>
        <?php } ?>
    </div>

</div>

<div id="articleModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeArticle()">&times;</span>
    <h2 id="modal-title" style="color:#00ff41;">Tool Name</h2>
    <img id="modal-img" src="" style="width:100%; height:200px; object-fit:cover; margin-bottom:15px;">
    
    <h3 style="color:gold;">Step-by-Step Commands:</h3>
    <div id="modal-desc" style="background:#000; padding:10px; border:1px solid #333; white-space: pre-wrap; font-family:monospace; color:#ccc;"></div>
    
    <div id="video-container" style="margin-top:20px; display:none;">
        <h3 style="color:red;">Practical Video:</h3>
        <iframe id="modal-video" width="100%" height="250" src="" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>
</div>

<script src="main.js"></script>
</body>
</html>

