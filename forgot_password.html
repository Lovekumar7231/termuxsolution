<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Recovery</title>
    <link rel="stylesheet" href="auth-style.css">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVZCY-3xLepXzcdWGtR34wqdXqJQevI7Q",
            authDomain: "termuxhacking-aac55.firebaseapp.com",
            projectId: "termuxhacking-aac55",
            storageBucket: "termuxhacking-aac55.firebasestorage.app",
            messagingSenderId: "921781091312",
            appId: "1:921781091312:web:39a1b96ceda5bc60b83b35"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db;
        window.dbRef = ref(db);
        window.dbChild = child;
        window.dbGet = get;
        window.dbUpdate = update;
    </script>

    <script type="text/javascript">
       (function(){ emailjs.init("ijs5TFBMM18XzlFac"); })();
    </script>
</head>
<body>

<div class="auth-box">
    <h2 class="glitch">RECOVER ACCESS</h2>

    <div id="recovery-step-1">
        <div class="input-group">
            <label>CODENAME (USERNAME)</label>
            <input type="text" id="recoveryUser" placeholder="Enter Codename">
        </div>
        <div class="input-group">
            <label>REGISTERED EMAIL</label>
            <input type="email" id="recoveryEmail" placeholder="email@example.com">
        </div>
        <button id="otpBtn" onclick="checkAndSendOTP()">SEND VERIFICATION OTP</button>
    </div>

    <div id="recovery-step-2" style="display:none;">
        <div class="input-group">
            <label>ENTER 4-DIGIT OTP</label>
            <input type="number" id="enteredOtp" placeholder="XXXX">
        </div>
        <button onclick="verifyRecoveryOtp()">VERIFY CODE</button>
    </div>

    <div id="recovery-step-3" style="display:none;">
        <div class="input-group">
            <label>NEW ACCESS KEY (PASSWORD)</label>
            <input type="password" id="newPass" placeholder="Enter New Password">
        </div>
        <button onclick="updateUserPassword()">REPLACE PASSWORD</button>
    </div>

    <div class="link-container">
        <div style="margin-top:15px; text-align:center;">
            <a href="login.html" style="color:#00ff41; text-decoration:none; font-size:13px;">‚Üê Back to Login</a>
        </div>
    </div>
</div>

<script>
    let actualOTP = 0;
    let validUser = "";

    async function checkAndSendOTP() {
        const user = document.getElementById("recoveryUser").value.trim();
        const email = document.getElementById("recoveryEmail").value.trim();
        const btn = document.getElementById("otpBtn");

        if(!user || !email) {
            alert("‚ö†Ô∏è Please fill all details!");
            return;
        }

        btn.innerText = "VERIFYING AGENT...";
        
        try {
            const snapshot = await window.dbGet(window.dbChild(window.dbRef, `users/${user}`));
            if (snapshot.exists() && snapshot.val().email === email) {
                validUser = user;
                sendEmailOTP(email);
            } else {
                alert("‚ùå Data Mismatch! Check Codename or Email.");
                btn.innerText = "SEND VERIFICATION OTP";
            }
        } catch (e) {
            alert("Database Error: " + e);
            btn.innerText = "SEND VERIFICATION OTP";
        }
    }

    function sendEmailOTP(email) {
        actualOTP = Math.floor(1000 + Math.random() * 9000); // 4 Digit OTP
        
        const params = {
            to_email: email,
            otp_code: actualOTP,
            name: validUser
        };

        emailjs.send("service_idclxul", "template_6sk2up1", params)
            .then(() => {
                alert("‚úÖ OTP sent to " + email);
                document.getElementById("recovery-step-1").style.display = "none";
                document.getElementById("recovery-step-2").style.display = "block";
            }, (err) => {
                alert("EmailJS Error: " + JSON.stringify(err));
            });
    }

    function verifyRecoveryOtp() {
        const inputOtp = document.getElementById("enteredOtp").value;
        if(inputOtp == actualOTP) {
            document.getElementById("recovery-step-2").style.display = "none";
            document.getElementById("recovery-step-3").style.display = "block";
        } else {
            alert("üö´ Invalid OTP Code!");
        }
    }

    async function updateUserPassword() {
        const newPassword = document.getElementById("newPass").value;
        if(newPassword.length < 4) {
            alert("‚ö†Ô∏è Password too short!");
            return;
        }

        try {
            // Firebase ‡§Æ‡•á‡§Ç ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡§æ
            const userRef = window.ref(window.db, 'users/' + validUser);
            await window.dbUpdate(userRef, { password: newPassword });
            alert("üîì Password Replaced! Log in with your new Key.");
            window.location.href = "login.html";
        } catch (e) {
            alert("Update Failed: " + e);
        }
    }
</script>

</body>
</html>

