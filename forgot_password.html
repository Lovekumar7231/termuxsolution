<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Recovery</title>
    <link rel="stylesheet" href="auth-style.css">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVZCY-3xLepXzcdWGtR34wqdXqJQevI7Q",
            authDomain: "termuxhacking-aac55.firebaseapp.com",
            projectId: "termuxhacking-aac55",
            storageBucket: "termuxhacking-aac55.firebasestorage.app",
            messagingSenderId: "921781091312",
            appId: "1:921781091312:web:39a1b96ceda5bc60b83b35"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db;
        window.dbRef = ref(db);
        window.update = update;
        window.get = get;
        window.child = child;
        window.dbRefObj = ref(db);
    </script>

    <script type="text/javascript">
       (function(){ emailjs.init("ijs5TFBMM18XzlFac"); })();
    </script>
</head>
<body>

<div class="auth-box">
    <h2 class="glitch">RECOVER ACCESS</h2>

    <div id="step-1">
        <div class="input-group">
            <label>ENTER CODENAME</label>
            <input type="text" id="recoveryUser" placeholder="Your Codename">
        </div>
        <div class="input-group">
            <label>REGISTERED EMAIL</label>
            <input type="email" id="recoveryEmail" placeholder="email@example.com">
        </div>
        <button id="otpBtn" onclick="verifyUserAndSendOTP()">SEND VERIFICATION OTP</button>
    </div>

    <div id="step-2" style="display:none;">
        <div class="input-group">
            <label>ENTER 4-DIGIT OTP</label>
            <input type="number" id="enteredOtp" placeholder="XXXX">
        </div>
        <button onclick="verifyOtp()">VERIFY CODE</button>
    </div>

    <div id="step-3" style="display:none;">
        <div class="input-group">
            <label>CREATE NEW ACCESS KEY</label>
            <input type="password" id="newPass" placeholder="Enter New Password">
        </div>
        <button onclick="updatePasswordInFirebase()">UPDATE PASSWORD</button>
    </div>

    <div class="link-container">
        <a href="login.html">‚Üê Return to Login</a>
    </div>
</div>

<script>
    let actualOTP = 0;
    let targetUser = "";

    function verifyUserAndSendOTP() {
        const username = document.getElementById("recoveryUser").value;
        const email = document.getElementById("recoveryEmail").value;
        const btn = document.getElementById("otpBtn");

        if(!username || !email) {
            alert("‚ö†Ô∏è Fill all fields!");
            return;
        }

        btn.innerText = "VERIFYING...";
        
        // Database ‡§Æ‡•á‡§Ç ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§ö‡•á‡§ï ‡§ï‡§∞‡§®‡§æ
        const dbRef = window.dbRefObj;
        window.get(window.child(dbRef, `users/${username}`)).then((snapshot) => {
            if (snapshot.exists() && snapshot.val().email === email) {
                targetUser = username;
                sendOTP(email);
            } else {
                alert("‚ùå User not found or Email mismatch!");
                btn.innerText = "SEND VERIFICATION OTP";
            }
        });
    }

    function sendOTP(email) {
        actualOTP = Math.floor(1000 + Math.random() * 9000);
        const params = { to_email: email, otp_code: actualOTP, name: targetUser };

        emailjs.send("service_idclxul", "template_6sk2up1", params)
            .then(() => {
                alert("‚úÖ OTP sent to " + email);
                document.getElementById("step-1").style.display = "none";
                document.getElementById("step-2").style.display = "block";
            });
    }

    function verifyOtp() {
        const input = document.getElementById("enteredOtp").value;
        if(input == actualOTP) {
            document.getElementById("step-2").style.display = "none";
            document.getElementById("step-3").style.display = "block";
        } else {
            alert("üö´ Wrong OTP!");
        }
    }

    function updatePasswordInFirebase() {
        const newPassword = document.getElementById("newPass").value;
        if(newPassword.length < 6) { alert("Too short!"); return; }

        // Firebase ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡§æ
        const userRef = window.ref(window.db, 'users/' + targetUser);
        window.update(userRef, {
            password: newPassword
        }).then(() => {
            alert("üîì Password Updated Successfully! Use new password to Login.");
            window.location.href = "login.html";
        }).catch((error) => {
            alert("Error updating: " + error);
        });
    }
</script>

</body>
</html>

